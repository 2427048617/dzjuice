<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商品分类展示</title>
  <style>
    /* 新增加载动画样式 */
    .loader {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-radius: 50%;
      border-top: 5px solid #e4393c;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* 购物车样式 */
    .cart-container {
      position: fixed;
      bottom: -100%; /* 初始位置在屏幕外 */
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
      display: block;
      z-index: 100;
      transition: bottom 0.3s ease;
    }

    .cart-container.active {
      bottom: 0; /* 显示时移动到屏幕底部 */
    }

    .cart-items {
      max-height: 200px;
      overflow-y: auto;
      margin: 5px 0; /* 减少标题和商品之间的间距 */
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .cart-item-info {
      display: flex;
      align-items: center;
    }

    .cart-item-quantity {
      margin-left: 10px;
      width: 30px;
    }

    .cart-item-actions {
      display: flex;
      gap: 5px;
    }

    .cart-item-actions button {
      padding: 3px 8px;
      background: #f0f0f0;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .cart-total {
      font-weight: bold;
      text-align: right;
      margin: 5px 0; /* 减少总价与商品之间的间距 */
    }

    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #e4393c;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 5px; /* 减少按钮与总价之间的间距 */
    }

    /* 新增购物车头部样式，包含关闭按钮 */
    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px; /* 减少标题和商品之间的间距 */
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #aaa;
    }

    /* 原有样式保持 */
    .filters {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .filter-btn {
      padding: 8px 15px;
      margin: 0 5px;
      background: #f0f0f0;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }

    .filter-btn.active {
      background: #e4393c;
      color: white;
    }

    #container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      padding: 0 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    .card {
      border: 1px solid #eee;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
      width: calc(100% + 5%);
      margin-left: -2.5%;
      margin-right: -2.5%;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .product-name {
      padding: 5px 10px;
      font-size: 14px;
      text-align: center;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .price-info {
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9f9f9;
    }

    .price {
      font-weight: bold;
      color: #e4393c;
    }

    .price-info button {
      padding: 5px 15px;
      background: #e4393c;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }

    /* 新增侧面购物车按钮样式 */
    .sidebar-cart-btn {
      position: fixed;
      bottom: 50%;
      right: 10px;
      transform: translateY(50%);
      padding: 12px 10px;
      background: #e4393c;
      color: white;
      border: none;
      border-radius: 5px 0 0 5px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 101;
    }
  </style>
</head>
<body>
  <!-- 加载动画 -->
  <div class="loader"></div>

  <div class="filters">
    <button class="filter-btn active" onclick="filterProducts('all')">全部</button>
    <button class="filter-btn" onclick="filterProducts('drinks')">饮品</button>
    <button class="filter-btn" onclick="filterProducts('snacks')">零食</button>
    <button class="filter-btn" onclick="filterProducts('daily')">日用品</button>
    <button class="filter-btn" onclick="filterProducts('other')">其它</button>
  </div>
  
  <div id="container"></div>

  <!-- 新增侧面购物车按钮 -->
  <button class="sidebar-cart-btn" onclick="toggleCart()">
    <span id="cart-count">0</span>
  </button>

  <!-- 购物车 -->
  <div class="cart-container">
    <div class="cart-header">
      <h3>购物车</h3>
      <button class="close-btn" onclick="toggleCart()">×</button>
    </div>
    <div class="cart-items"></div>
    <div class="cart-total">总价：<span id="total-price">0</span>元</div>
    <button class="checkout-btn" onclick="handleCheckout()">去下单</button>
  </div>

<script>
  // 模拟加载动画
  document.querySelector('.loader').style.display = 'block';
  
  // 购物车数据
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  let products = [];

  // 从GitHub获取商品数据
  async function fetchProductsFromGitHub() {
    try {
      // 使用用户提供的GitHub链接
      const response = await fetch('https://2427048617.github.io/dzshop/products.json');
      if (!response.ok) {
        throw new Error('请求失败');
      }
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('从GitHub获取商品数据失败:', error);
      // 使用默认商品数据
      return [
        { 
          id: 1,
          name: "矿泉水", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 3, 
          discount: "5瓶包邮", 
          category: "drinks",
          stock: 100
        },
        { 
          id: 2,
          name: "可乐", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 4, 
          discount: "3瓶包邮", 
          category: "drinks",
          stock: 100
        },
        { 
          id: 3,
          name: "薯片", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 8, 
          discount: "满20元包邮", 
          category: "snacks",
          stock: 100
        },
        { 
          id: 4,
          name: "巧克力", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 12, 
          discount: "满30元包邮", 
          category: "snacks",
          stock: 100
        },
        { 
          id: 5,
          name: "毛巾", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 25, 
          discount: "满50元包邮", 
          category: "daily",
          stock: 100
        },
        { 
          id: 6,
          name: "洗发水", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 35, 
          discount: "满60元包邮", 
          category: "daily",
          stock: 100
        },
        { 
          id: 7,
          name: "书本", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 45, 
          discount: "满80元包邮", 
          category: "other",
          stock: 100
        },
        { 
          id: 8,
          name: "笔记本", 
          image: "https://s21.ax1x.com/2025/03/12/pEUFQ6P.jpg", 
          price: 15, 
          discount: "满30元包邮", 
          category: "other",
          stock: 100
        }
      ];
    }
  }

  // 初始化页面
  window.addEventListener('DOMContentLoaded', async () => {
    products = await fetchProductsFromGitHub();
    renderProducts('all');
    updateCartDisplay();
    setTimeout(() => {
      document.querySelector('.loader').style.display = 'none';
    }, 1000);
  });

  // 加入购物车功能
  function addToCart(product) {
    // 检查商品库存
    if (product.stock <= 0) {
      alert(`${product.name} 已售罄，无法购买！`);
      return;
    }

    // 更新商品库存
    const updatedProducts = products.map(p => {
      if (p.id === product.id) {
        return { ...p, stock: p.stock - 1 };
      }
      return p;
    });

    // 保存更新后的商品数据到GitHub（实际应用中需要后端支持）
    // 这里仅做模拟
    products = updatedProducts;

    // 更新购物车
    const existing = cart.find(item => item.id === product.id);
    if (existing) {
      existing.quantity++;
    } else {
      cart.push({
        ...product,
        quantity: 1
      });
    }

    saveCartToLocalStorage();
    updateCartDisplay();
  }

  // 修改商品数量
  function changeQuantity(productId, change) {
    const product = cart.find(item => item.id === productId);
    if (product) {
      product.quantity += change;
      if (product.quantity <= 0) {
        removeFromCart(productId);
      } else {
        saveCartToLocalStorage();
        updateCartDisplay();
      }
    }
  }

  // 从购物车中删除商品
  function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    saveCartToLocalStorage();
    updateCartDisplay();
  }

  // 更新购物车显示
  function updateCartDisplay() {
    const cartItems = document.querySelector('.cart-items');
    const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // 更新购物车内容
    cartItems.innerHTML = cart.map(item => `
      <div class="cart-item">
        <div class="cart-item-info">
          <span>${item.name}</span>
          <input type="number" class="cart-item-quantity" value="${item.quantity}" min="1" onchange="changeQuantity(${item.id}, this.value - ${item.quantity})">
        </div>
        <div class="cart-item-actions">
          <button onclick="changeQuantity(${item.id}, 1)">+</button>
          <button onclick="changeQuantity(${item.id}, -1)">-</button>
          <button onclick="removeFromCart(${item.id})">删除</button>
        </div>
        <span>${(item.price * item.quantity).toFixed(2)}元</span>
      </div>
    `).join('');

    document.getElementById('total-price').textContent = totalPrice.toFixed(2);
    document.getElementById('cart-count').textContent = cart.length;
  }

  // 保存购物车到本地存储
  function saveCartToLocalStorage() {
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  // 处理下单
  function handleCheckout() {
    if (cart.length === 0) {
      alert('购物车为空！');
      return;
    }
    
    const orderText = cart.map(item => 
      `${item.quantity}个${item.name}`
    ).join('\n') + `\n总价：${document.getElementById('total-price').textContent}元`;

    try {
      navigator.clipboard.writeText(orderText).then(() => {
        alert('订单信息已复制，请打开微信手动粘贴订单内容。');
        try {
          // 打开微信客户端
          window.location.href = 'weixin://';
        } catch (e) {
          alert('自动打开微信失败，请手动打开微信并粘贴订单信息。');
        }
        // 下单后清除购物车
        cart = [];
        saveCartToLocalStorage();
        updateCartDisplay();
      });
    } catch (e) {
      alert('复制订单信息失败，请手动选择商品并粘贴。');
    }
  }

  // 渲染商品
  function renderProducts(category) {
    const container = document.getElementById('container');
    let filteredProducts = category === 'all' 
      ? products 
      : products.filter(product => product.category === category);
    
    container.innerHTML = filteredProducts.map(product => `
      <div class="card">
        <div class="product-name">${product.name}</div>
        <img src="${product.image}" alt="${product.name}">
        <div class="price-info">
          <span class="price">${product.price}元</span>
          <button onclick="addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})">购买</button>
        </div>
      </div>
    `).join('');
  }

  // 筛选商品
  function filterProducts(category) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
    renderProducts(category);
  }

  // 切换购物车显示
  function toggleCart() {
    const cartContainer = document.querySelector('.cart-container');
    cartContainer.classList.toggle('active');
    updateCartDisplay();
  }
</script>
</body>
</html>
